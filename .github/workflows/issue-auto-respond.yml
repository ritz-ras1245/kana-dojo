name: Auto-Reply to Issue Comments

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  contents: read

jobs:
  auto-respond:
    if: ${{ !github.event.issue.pull_request && contains(github.event.issue.labels.*.name, 'community') && github.event.comment.user.login != 'github-actions[bot]' }}

    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout for templates
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Check and respond to commenter
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const templates = require('./.github/templates/messages.cjs');
            const t = templates.issueAutoRespond;

            const issue = context.payload.issue;
            const commenter = context.payload.comment.user.login;

            if (issue.assignees && issue.assignees.length > 0) {
              const assignee = issue.assignees[0].login;
              
              if (assignee !== commenter) {
                const msg = t.alreadyAssigned;
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `${msg.greeting.replace('{commenter}', commenter)}\n\n${msg.body.replace('{assignee}', assignee)}\n\n${msg.suggestion}\n\n${msg.encouragement}`
                });
              }
              return;
            }

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              assignees: [commenter]
            });

            const msg = t.assigned;
            const nextSteps = msg.nextSteps.items.map(function(item, i) {
              return `${i + 1}. ${item.replace('{issueNumber}', issue.number)}`;
            }).join('\n');

            const resources = msg.resources.items.map(function(item) {
              return '- ' + item;
            }).join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `${msg.greeting.replace('{commenter}', commenter)}\n\n${msg.body}\n\n${msg.nextSteps.title}\n${nextSteps}\n\n${msg.resources.title}\n${resources}\n\n${msg.footer}\n\n${msg.encouragement}`
            });

            console.log(`Assigned issue #${issue.number} to @${commenter}`);
